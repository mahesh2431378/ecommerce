<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Bookory</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-orange: #FF6600;
            --accent-orange-light: #fff1e6;
            --dark-text: #2c3e50;
            --secondary-text-color: #6c757d;
            --card-bg: #ffffff;
            --bg-light: #f7f9fc;
            --border-color: #e9ecef;
            --success-green: #28a745;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--dark-text);
        }

        .text-primary { color: var(--accent-orange) !important; }
        .btn-primary { background-color: var(--accent-orange); border-color: var(--accent-orange); }
        .btn-primary:hover { background-color: #e65c00; border-color: #e65c00; }
        .navbar-brand { font-weight: 700; font-size: 1.5rem; }

        /* --- Profile Page Overhaul --- */
        .profile-sidebar { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }
        .profile-header { padding: 1.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
        .profile-header .profile-avatar { font-size: 3rem; color: var(--accent-orange); }
        .profile-sidebar .nav-link { color: var(--secondary-text-color); font-weight: 500; padding: 0.9rem 1.5rem; transition: all 0.2s ease-in-out; cursor: pointer; }
        .profile-sidebar .nav-link.active, .profile-sidebar .nav-link:hover { color: var(--accent-orange); background-color: var(--accent-orange-light); }
        .profile-sidebar .nav-link i { margin-right: 12px; font-size: 1.2rem; }
        
        .content-section-card { background-color: var(--card-bg); border-radius: 12px; padding: 2rem; box-shadow: 0 4px 25px rgba(0,0,0,0.05); }
        .content-section-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .content-section-card .card-header h5 { font-weight: 600; margin-bottom: 0; }
        
        .info-group p { margin-bottom: 0; }
        .info-group .info-label { color: var(--secondary-text-color); font-size: 0.9rem; }

        .address-card { border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 10px; }
        .order-history-card { border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 10px; }
        .order-history-card img { width: 60px; height: 80px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>
    <header class="bg-white sticky-top shadow-sm">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid px-md-4">
                <a class="navbar-brand text-primary me-4" href="homepage.html">Bookory</a>
                <div class="collapse navbar-collapse" id="mainNavbar">
                     <ul class="navbar-nav ms-auto d-flex align-items-center">
                         <li class="nav-item dropdown user-nav-item">
                            <a class="nav-link dropdown-toggle fw-medium" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-person-circle me-1"></i> User</a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="myprofile.html"><i class="bi bi-person me-2"></i> My Profile</a></li>
                                <li><a class="dropdown-item" href="orders.html"><i class="bi bi-box-seam me-2"></i> Orders</a></li>
                                <li><a class="dropdown-item" href="login.html" id="logout-link"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container py-5">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3">
                <aside class="profile-sidebar p-3">
                    <div class="profile-header">
                        <i class="bi bi-person-circle profile-avatar"></i>
                        <h5 class="mb-0 mt-2">Hello, John</h5>
                        <p class="text-muted small">john.doe@example.com</p>
                    </div>
                    <nav class="nav flex-column nav-pills mt-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <a class="nav-link active" id="v-pills-profile-tab" data-bs-toggle="pill" href="#v-pills-profile" role="tab"><i class="bi bi-person-vcard"></i>Account Settings</a>
                        <a class="nav-link" id="v-pills-history-tab" data-bs-toggle="pill" href="#v-pills-history" role="tab"><i class="bi bi-box-seam"></i>Order History</a>
                        <a class="nav-link" id="v-pills-address-tab" data-bs-toggle="pill" href="#v-pills-address" role="tab"><i class="bi bi-geo-alt"></i>Manage Addresses</a>
                    </nav>
                </aside>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="tab-content">
                    <!-- Profile Information Tab -->
                    <div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel">
                         <div class="content-section-card">
                             <div class="card-header">
                                 <h5>Personal Information</h5>
                                 <button class="btn btn-outline-primary btn-sm" id="edit-profile-btn"><i class="bi bi-pencil-square me-1"></i> Edit</button>
                             </div>
                             <!-- Static Info View -->
                             <div id="static-info">
                                 <div class="row g-4">
                                     <div class="col-md-6 info-group"><p class="info-label">First Name</p><p class="fw-medium" data-field="firstName">John</p></div>
                                     <div class="col-md-6 info-group"><p class="info-label">Last Name</p><p class="fw-medium" data-field="lastName">Doe</p></div>
                                     <div class="col-md-6 info-group"><p class="info-label">Email Address</p><p class="fw-medium" data-field="email">john.doe@example.com</p></div>
                                     <div class="col-md-6 info-group"><p class="info-label">Phone Number</p><p class="fw-medium" data-field="phone">123-456-7890</p></div>
                                     <div class="col-md-6 info-group"><p class="info-label">Gender</p><p class="fw-medium" data-field="gender">Male</p></div>
                                     <div class="col-md-6 info-group"><p class="info-label">Date of Birth</p><p class="fw-medium" data-field="dob">1990-01-01</p></div>
                                 </div>
                             </div>
                             <!-- Editable Form View (hidden by default) -->
                             <form id="editable-form" class="d-none">
                                 <div class="row g-3">
                                     <div class="col-md-6"><label class="form-label">First Name</label><input type="text" class="form-control" id="firstNameInput" value="John"></div>
                                     <div class="col-md-6"><label class="form-label">Last Name</label><input type="text" class="form-control" id="lastNameInput" value="Doe"></div>
                                     <div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="emailInput" value="john.doe@example.com" disabled></div>
                                     <div class="col-md-6"><label class="form-label">Phone</label><input type="tel" class="form-control" id="phoneInput" value="123-456-7890"></div>
                                     <div class="col-md-6"><label class="form-label">Gender</label><select class="form-select" id="genderInput"><option value="Male">Male</option><option value="Female">Female</option><option value="Prefer not to say">Prefer not to say</option></select></div>
                                     <div class="col-md-6"><label class="form-label">Date of Birth</label><input type="date" class="form-control" id="dobInput" value="1990-01-01"></div>
                                     <div class="col-12 text-end mt-3"><button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancel</button><button type="submit" class="btn btn-primary" id="save-profile-btn">Save Changes</button></div>
                                 </div>
                             </form>
                         </div>
                    </div>

                    <!-- Order History Tab -->
                    <div class="tab-pane fade" id="v-pills-history" role="tabpanel">
                        <div class="content-section-card">
                            <div class="card-header">
                                <h5>Order History</h5>
                            </div>
                            <div id="order-history-list">
                                <!-- Past orders will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Address Book Tab -->
                    <div class="tab-pane fade" id="v-pills-address" role="tabpanel">
                         <div class="content-section-card">
                             <div class="card-header">
                                 <h5>Manage Addresses</h5>
                                 <a href="addaddress.html" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg me-1"></i>Add New Address</a>
                             </div>
                             <div id="address-list"></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    $(document).ready(function() {
        if (localStorage.getItem('isLoggedIn') == 'false') { window.location.href = 'login.html'; }

        // --- Profile Information Management ---
        function loadProfileInfo() {
            let userProfile = JSON.parse(localStorage.getItem('userProfile'));

            // If no profile exists, create a default one
            if (!userProfile) {
                userProfile = {
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'john.doe@example.com',
                    phone: '123-456-7890',
                    gender: 'Male',
                    dob: '1990-01-01'
                };
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
            }

            // Populate static fields
            $('[data-field="firstName"]').text(userProfile.firstName);
            $('[data-field="lastName"]').text(userProfile.lastName);
            $('[data-field="email"]').text(userProfile.email);
            $('[data-field="phone"]').text(userProfile.phone);
            $('[data-field="gender"]').text(userProfile.gender);
            $('[data-field="dob"]').text(userProfile.dob);

            // Update sidebar header
            $('.profile-header h5').text('Hello, ' + userProfile.firstName);
            $('.profile-header .small').text(userProfile.email);
        }

        $('#edit-profile-btn').on('click', function() {
            const userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
            // Populate form with current data
            $('#firstNameInput').val(userProfile.firstName);
            $('#lastNameInput').val(userProfile.lastName);
            $('#emailInput').val(userProfile.email);
            $('#phoneInput').val(userProfile.phone);
            $('#genderInput').val(userProfile.gender);
            $('#dobInput').val(userProfile.dob);
            
            $('#static-info').addClass('d-none');
            $('#editable-form').removeClass('d-none');
        });

        $('#cancel-edit-btn').on('click', function() {
            $('#static-info').removeClass('d-none');
            $('#editable-form').addClass('d-none');
        });

        $('#editable-form').on('submit', function(e) {
            e.preventDefault();
            
            // Create updated profile object from form
            const updatedProfile = {
                firstName: $('#firstNameInput').val(),
                lastName: $('#lastNameInput').val(),
                email: $('#emailInput').val(), // Email is disabled, but we keep it
                phone: $('#phoneInput').val(),
                gender: $('#genderInput').val(),
                dob: $('#dobInput').val()
            };
            
            // Save updated profile to localStorage
            localStorage.setItem('userProfile', JSON.stringify(updatedProfile));
            
            // Reload the info to reflect changes
            loadProfileInfo();

            // Switch back to static view
            $('#static-info').removeClass('d-none');
            $('#editable-form').addClass('d-none');
        });

        // --- Address Management ---
        function renderAddresses() {
            const addresses = JSON.parse(localStorage.getItem('userAddresses')) || [];
            const container = $('#address-list');
            container.empty();
            if (addresses.length === 0) {
                container.html('<p class="text-muted mt-3">You have no saved addresses.</p>');
                return;
            }
            addresses.forEach((addr, index) => {
                const addressCard = `
                    <div class="address-card mt-3">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">${addr.fullName}</h6>
                            <div>
                                <a href="addaddress.html?edit=${index}" class="text-primary me-3"><i class="bi bi-pencil-square"></i> Edit</a>
                                <a href="#" class="text-danger remove-addr-btn" data-index="${index}"><i class="bi bi-trash"></i> Remove</a>
                            </div>
                        </div>
                        <p class="text-muted mb-0">${addr.addressLine1}, ${addr.addressLine2}, ${addr.city}, ${addr.state} - ${addr.pincode}</p>
                        <p class="text-muted mb-0">Mobile: ${addr.mobileNumber}</p>
                    </div>
                `;
                container.append(addressCard);
            });
        }

        $(document).on('click', '.remove-addr-btn', function(e) {
            e.preventDefault();
            const indexToRemove = $(this).data('index');
            let addresses = JSON.parse(localStorage.getItem('userAddresses')) || [];
            addresses.splice(indexToRemove, 1);
            localStorage.setItem('userAddresses', JSON.stringify(addresses));
            renderAddresses();
        });

        // --- Order History Logic ---
        function renderOrderHistory() {
            const orders = JSON.parse(localStorage.getItem('userOrders')) || [];
            const container = $('#order-history-list');
            container.empty();
            const pastOrders = orders.filter(o => o.status === 'Delivered' || o.status === 'Cancelled');
            
            if (pastOrders.length === 0) {
                container.html('<p class="text-muted mt-3">You have no past orders.</p>');
                return;
            }

            pastOrders.forEach(order => {
                const itemsHtml = order.items.map(item => `
                    <div class="d-flex align-items-center">
                        <img src="https://placehold.co/100x150/A68F81/FFFFFF?text=Book" alt="${item.title}">
                        <div class="ms-3">
                            <h6 class="mb-1">${item.title}</h6>
                            <p class="text-muted small mb-0">by ${item.author}</p>
                        </div>
                    </div>
                `).join('<hr class="my-3">');

                const orderCard = `
                    <div class="order-history-card mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-0">Order #${order.id}</h6>
                                <small class="text-muted">Placed on ${order.date}</small>
                            </div>
                            <span class="badge bg-success-subtle text-success-emphasis rounded-pill">${order.status}</span>
                        </div>
                        ${itemsHtml}
                    </div>
                `;
                container.append(orderCard);
            });
        }

        // Logout Logic
        $('#logout-link').on('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'login.html';
        });

        // --- Initial Page Load ---
        loadProfileInfo();
        renderAddresses();
        renderOrderHistory();
    });
    </script>
</body>
</html>
